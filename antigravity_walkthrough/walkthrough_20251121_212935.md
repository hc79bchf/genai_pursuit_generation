# Walkthrough: Refactor LLM Service for Structured Output

## Goal
Refactor `LLMService` to use Anthropic's "Tool Use" capability (function calling) to enforce structured JSON output based on Pydantic models, replacing the previous prompt-engineering approach.

## Changes

### 1. LLM Service (`backend/app/services/ai_service/llm_service.py`)
- Updated `generate_json` to accept a Pydantic model class.
- Converted the Pydantic model to a JSON schema.
- Used `client.messages.create` with `tools` and `tool_choice` to force the model to generate arguments matching the schema.
- Removed manual JSON parsing and markdown stripping logic.

### 2. Metadata Extraction Agent (`backend/app/services/ai_service/metadata_agent.py`)
- Simplified the system prompt by removing explicit instructions about JSON formatting (e.g., "Return ONLY JSON", "Do not use markdown").
- Relies on `LLMService` to handle the structured output.

## Verification

### Unit Tests
Ran `pytest backend/tests/unit/test_metadata_agent.py` to verify logic.
- **Status:** ✅ Passed
- **Tests:** `test_extract_metadata_success`, `test_extract_metadata_partial`

```bash
$ pytest backend/tests/unit/test_metadata_agent.py
============================= test session starts ==============================
platform darwin -- Python 3.13.2, pytest-8.4.2, pluggy-1.6.0
rootdir: /Users/hongfeicao/Desktop/ClaudeCode/pursuit_response_1
configfile: pytest.ini
plugins: anyio-4.11.0, asyncio-0.25.0
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None
collected 2 items                                                              

backend/tests/unit/test_metadata_agent.py ..                             [100%]

============================== 2 passed in 0.07s ===============================
```

### Manual Verification
Ran `scripts/run_metadata_extraction.py` against `Data/AI_Platform_RFP.docx`.
- **Status:** ✅ Success
- **Output:**
```json
{
  "entity_name": "Leading financial services organization",
  "industry": "Financial Services",
  "service_types": ["Engineering", "Data"],
  "technologies": ["Azure", "AWS"],
  "submission_due_date": "2025-02-28",
  "expected_format": "docx"
}
```
